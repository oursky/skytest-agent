generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id              String    @id @default(cuid())
  authId          String    @unique
  email           String?
  openRouterKey   String?   // Encrypted OpenRouter API key
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  projects        Project[]
  usageRecords    UsageRecord[]
}

model UsageRecord {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // "TEST_RUN"
  description String?  // e.g., "Project Name - Test Case Name"
  aiActions   Int      // Exact number of AI actions executed
  testRunId   String?  // Reference to test run for linking
  testRun     TestRun? @relation(fields: [testRunId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
}

model Project {
  id        String     @id @default(cuid())
  name      String
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  testCases TestCase[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId, updatedAt(sort: Desc)])
}

model TestCase {
  id        String    @id @default(cuid())
  displayId String?   // User-editable display ID (optional)
  status    String    @default("DRAFT") // DRAFT | PASS | FAIL | CANCELLED | RUNNING | QUEUED
  name      String
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  url       String
  prompt    String?
  steps     String?
  browserConfig String?
  username  String?
  password  String?
  testRuns  TestRun[]
  files     TestCaseFile[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([projectId, updatedAt(sort: Desc)])
}

model TestCaseFile {
  id          String   @id @default(cuid())
  testCaseId  String
  testCase    TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  filename    String
  storedName  String
  mimeType    String
  size        Int
  createdAt   DateTime @default(now())

  @@unique([testCaseId, filename])
  @@index([testCaseId])
}

model TestRun {
  id                      String   @id @default(cuid())
  testCaseId              String
  testCase                TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  status                  String
  result                  String?
  logs                    String?
  error                   String?
  configurationSnapshot   String?
  startedAt               DateTime?
  completedAt             DateTime?
  createdAt               DateTime @default(now())
  usageRecords            UsageRecord[]
  files                   TestRunFile[]

  @@index([testCaseId, createdAt(sort: Desc)])
  @@index([status])
}

model TestRunFile {
  id         String   @id @default(cuid())
  runId      String
  testRun    TestRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  filename   String
  storedName String
  mimeType   String
  size       Int
  createdAt  DateTime @default(now())

  @@index([runId])
}
